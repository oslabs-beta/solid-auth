import{getRequestEvent as S,isServer as l}from"solid-js/web";import{provideRequestEvent as Q}from"solid-js/web/storage";import{H3Event as O,setResponseStatus as V,appendResponseHeader as Y,useSession as Z,setHeader as ee,getRequestIP as te,getResponseStatus as ne,getResponseStatusText as re,getCookie as se,setCookie as oe,getRequestURL as ae,getResponseHeaders as ie,getResponseHeader as ue,setResponseHeader as ce,removeResponseHeader as de,getRequestWebStream as fe}from"h3";import{getContext as le}from"unctx";import{AsyncLocalStorage as ge}from"node:async_hooks";import{createStorage as he}from"unstorage";import pe from"unstorage/drivers/fs-lite";import{createContext as W,useContext as ye,createSignal as U,getOwner as M,getListener as we,onCleanup as B,startTransition as x,sharedConfig as R,createMemo as me,$TRACK as Re}from"solid-js";function Se(e){let t;const n=N(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=Ae(e),t)}})}function ve(e){return e.web??={request:Se(e),url:N(e)},e.web.request}function be(){return Ue()}const D=Symbol("$HTTPEvent");function Ee(e){return typeof e=="object"&&(e instanceof O||e?.[D]instanceof O||e?.__is_event__===!0)}function d(e){return function(...t){let n=t[0];if(Ee(n))t[0]=n instanceof O||n.__is_event__?n:n[D];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=be(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const N=d(ae),$e=d(te),L=d(V),k=d(ne),xe=d(re),$=d(ie),j=d(ue),Ce=d(ce),K=d(Y),ft=d(se),lt=d(oe),He=d(Z),gt=d(ee),Ae=d(fe),Te=d(de),Oe=d(ve);function qe(){return le("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ge})}function Ue(){return qe().use().event}const T=Symbol("fetchEvent");function Ie(e){return{request:Oe(e),response:Le(e),clientAddress:$e(e),locals:{},nativeEvent:e}}function _e(e){return{...e}}function ht(e){if(!e[T]){const t=Ie(e);e[T]=t}return e[T]}function pt(e,t){for(const[n,r]of t.entries())K(e,n,r)}class Pe{event;constructor(t){this.event=t}get(t){const n=j(this.event,t);return Array.isArray(n)?n.join(", "):n||null}has(t){return this.get(t)!==void 0}set(t,n){return Ce(this.event,t,n)}delete(t){return Te(this.event,t)}append(t,n){K(this.event,t,n)}getSetCookie(){const t=j(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries($(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries($(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys($(this.event))[Symbol.iterator]()}values(){return Object.values($(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Le(e){return{get status(){return k(e)},set status(t){L(e,t)},get statusText(){return xe(e)},set statusText(t){L(e,k(e),t)},headers:new Pe(e)}}function H(e,t,n){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const r="";return new Proxy(e,{get(s,o,c){return o==="url"?`${r}/_server?id=${encodeURIComponent(t)}&name=${encodeURIComponent(n)}`:o==="GET"?c:s[o]},apply(s,o,c){const u=S();if(!u)throw new Error("Cannot call server function outside of a request");const f=_e(u);return f.locals.serverFunctionMeta={id:t+"#"+n},f.serverOnly=!0,Q(f,()=>e.apply(o,c))}})}const ke="http://sr";function je(e,t){if(e==null)throw new Error(t);return e}const Fe=W();W();const X=()=>je(ye(Fe),"<A> and 'use' router primitives can be only used inside a Route."),We=()=>X().navigatorFactory();let Me;function Be(){return Me}const De="Location",Ne=5e3,Ke=18e4;let b=new Map;l||setInterval(()=>{const e=Date.now();for(let[t,n]of b.entries())!n[3].count&&e-n[0]>Ke&&b.delete(t)},3e5);function I(){if(!l)return b;const e=S();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function Xe(e,t=!0){return x(()=>{const n=Date.now();G(e,r=>{t&&(r[0]=0),r[3][1](n)})})}function G(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of b.keys())(e===void 0||Ge(n,e))&&t(b.get(n))}function A(e,t){e.GET&&(e=e.GET);const n=(...r)=>{const s=I(),o=Be(),u=M()?We():void 0,f=Date.now(),g=t+q(r);let a=s.get(g),m;if(l){const i=S();if(i){const y=(i.router||(i.router={})).dataOnly;if(y){const w=i&&(i.router.data||(i.router.data={}));if(w&&g in w)return w[g];if(Array.isArray(y)&&!y.includes(g))return w[g]=void 0,Promise.resolve()}}}if(we()&&!l&&(m=!0,B(()=>a[3].count--)),a&&a[0]&&(l||o==="native"||a[3].count||Date.now()-a[0]<Ne)){m&&(a[3].count++,a[3][0]()),a[2]==="preload"&&o!=="preload"&&(a[0]=f);let i=a[1];return i="then"in a[1]?a[1].then(p(!1),p(!0)):p(!1)(a[1]),!l&&o==="navigate"&&x(()=>a[3][1](a[0])),i}let h=!l&&R.context&&R.has(g)?R.load(g):e(...r);if(a?(a[0]=f,a[1]=h,a[2]=o,!l&&o==="navigate"&&x(()=>a[3][1](a[0]))):(s.set(g,a=[f,h,o,U(f)]),a[3].count=0),m&&(a[3].count++,a[3][0]()),l){const i=S();if(i&&i.router.dataOnly)return i.router.data[g]=h}if(h="then"in h?h.then(p(!1),p(!0)):p(!1)(h),l&&R.context&&R.context.async&&!R.context.noHydrate){const i=S();(!i||!i.serverOnly)&&R.context.serialize(g,h)}return h;function p(i){return async y=>{if(y instanceof Response){const w=y.headers.get(De);if(w!==null){if(u&&w.startsWith("/"))x(()=>{u(w,{replace:!0})});else if(!l)window.location.href=w;else if(l){const P=S();P&&(P.response={status:302,headers:new Headers({Location:w})})}return}y.customBody&&(y=await y.customBody())}if(i)throw y;return y}}};return n.keyFor=(...r)=>t+q(r),n.key=t,n}A.set=(e,t)=>{const n=I(),r=Date.now();let s=n.get(e);s?(s[0]=r,s[1]=t,s[2]="preload"):(n.set(e,s=[r,t,,U(r)]),s[3].count=0)};A.clear=()=>I().clear();function Ge(e,t){for(let n of t)if(e.startsWith(n))return!0;return!1}function q(e){return JSON.stringify(e,(t,n)=>ze(n)?Object.keys(n).sort().reduce((r,s)=>(r[s]=n[s],r),{}):n)}function ze(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const F=new Map;function Je(e,t){const n=X(),r=me(()=>n.submissions[0]().filter(s=>s.url===e.toString()&&!t));return new Proxy([],{get(s,o){return o===Re?r():o==="pending"?r().some(c=>!c.result):r()[o]}})}function yt(e,t){const n=Je(e,t);return new Proxy({},{get(r,s){return n.length===0&&s==="clear"||s==="retry"?()=>{}:n[n.length-1]?.[s]}})}function z(e,t){function n(...s){const o=this.r,c=this.f,u=(o.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...s),[f,g]=U();let a;function m(h){return async p=>{const i=await Ve(p,h,o.navigatorFactory());if(!i)return a.clear();if(g(i),i.error&&!c)throw i.error;return i.data}}return o.submissions[1](h=>[...h,a={input:s,url:r,get result(){return f()?.data},get error(){return f()?.error},get pending(){return!f()},clear(){o.submissions[1](p=>p.filter(i=>i.input!==s))},retry(){return g(void 0),e(...s).then(m(),m(!0))}}]),u.then(m(),m(!0))}const r=e.url||t||(l?"":`https://action/${Qe(e.toString())}`);return J(n,r)}function J(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const r=function(...o){return e.call(this,...n,...o)},s=new URL(t,ke);return s.searchParams.set("args",q(n)),J(r,(s.origin==="https://action"?s.origin:"")+s.pathname+s.search)},e.url=t,l||(F.set(t,e),M()&&B(()=>F.delete(t))),e}const Qe=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function Ve(e,t,n){let r,s,o,c;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(o=e.headers.get("X-Revalidate").split(",")),e.customBody&&(r=s=await e.customBody(),e.headers.has("X-Single-Flight")&&(r=r._$value,delete s._$value,c=Object.keys(s))),e.headers.has("Location")){const u=e.headers.get("Location")||"/";u.startsWith("http")?window.location.href=u:n(u)}}else{if(t)return{error:e};r=e}return G(o,u=>u[0]=0),c&&c.forEach(u=>A.set(u,s[u])),await Xe(o,!1),r!=null?{data:r}:void 0}function _(e,t=302){let n,r;typeof t=="number"?n={status:t}:({revalidate:r,...n}=t,typeof n.status>"u"&&(n.status=302));const s=new Headers(n.headers);return s.set("Location",e),r&&s.set("X-Revalidate",r.toString()),new Response(null,{...n,headers:s})}const v=he({driver:pe({base:"./.data"})});v.setItem("users:data",[{id:0,username:"kody",password:"twixrox"}]);v.setItem("users:counter",1);const C={user:{async create({data:e}){const[{value:t},{value:n}]=await v.getItems(["users:data","users:counter"]),r={...e,id:n};return await Promise.all([v.setItem("users:data",[...t,r]),v.setItem("users:counter",n+1)]),r},async findUnique({where:{username:e=void 0,id:t=void 0}}){const n=await v.getItem("users:data");return t!==void 0?n.find(r=>r.id===t):n.find(r=>r.username===e)}}},E={getSession:async()=>{const e=await He({password:process.env.SESSION_SECRET??"areallylongsecretthatyoushouldreplace"});return{...e,update:async t=>{const n={...e.data};t(n),await e.update(r=>({...r,...n}))}}},login:async(e,t)=>{const n=await C.user.findUnique({where:{username:e}});if(!n||t!==n.password)throw new Error("Invalid login");return{...n,id:n.id}},register:async(e,t)=>{if(await C.user.findUnique({where:{username:e}}))throw new Error("User already exists");return C.user.create({data:{username:e,password:t}})},logout:async()=>{const e=await E.getSession();e?.data.userId&&await e.update(t=>{t.userId=void 0})},validateUsername:e=>{if(typeof e!="string"||e.length<3)return"Usernames must be at least 3 characters long"},validatePassword:e=>{if(typeof e!="string"||e.length<6)return"Passwords must be at least 6 characters long"}},wt=A(H(Ze,"c_5810","$$function0"),"user"),mt=z(H(et,"c_5810","$$function1")),Ye=H(tt,"c_5810","$$function2"),Rt=z(H(nt,"c_5810","$$function3"));async function Ze(){try{const e=await E.getSession(),t=Number(e.data.userId);if(t===void 0)throw new Error("User not found");const n=await C.user.findUnique({where:{id:t}});if(!n)throw new Error("User not found");return{id:n.id,username:n.username}}catch{await E.logout(),_("/login")}}async function et(e){return Ye(e,E)}async function tt(e,t){const n=String(e.get("username")),r=String(e.get("password")),s=String(e.get("loginType"));let o=t.validateUsername(n)||t.validatePassword(r);if(o)return new Error(o);try{const c=await(s!=="login"?t.register(n,r):t.login(n,r));await(await t.getSession()).update(f=>{f.userId=c.id.toString()})}catch(c){return c}return _("/")}async function nt(){return await E.logout(),_("/login")}export{Ze as $,ft as a,ht as b,L as c,gt as d,_e as e,mt as f,wt as g,et as h,tt as i,nt as j,Rt as l,pt as m,lt as s,yt as u};
