import{fromJSON as F,crossSerializeStream as X,getCrossReferenceHeader as j}from"seroval";import{CustomEventPlugin as w,DOMExceptionPlugin as R,EventPlugin as S,FormDataPlugin as $,HeadersPlugin as v,ReadableStreamPlugin as b,RequestPlugin as P,ResponsePlugin as k,URLSearchParamsPlugin as E,URLPlugin as T}from"seroval-plugins/web";import{lazy as _,createComponent as z,sharedConfig as H}from"solid-js";import{ssrElement as h,escape as L,mergeProps as J,ssr as W,renderToString as G}from"solid-js/web";import{provideRequestEvent as D}from"solid-js/web/storage";import{g as K,a as V,s as Q,b as Y,m as A,c as U,d as m,e as Z}from"./index2.mjs";import{eventHandler as ee}from"h3";import"node:async_hooks";import{createRouter as te}from"radix3";import"unctx";import"unstorage";import"unstorage/drivers/fs-lite";const g="Invariant Violation",{setPrototypeOf:re=function(e,r){return e.__proto__=r,e}}=Object;class x extends Error{framesToPop=1;name=g;constructor(r=g){super(typeof r=="number"?`${g}: ${r} (see https://github.com/apollographql/invariant-packages)`:r),re(this,x.prototype)}}function se(e,r){if(!e)throw new x(r)}const ne={preload(){K()}},N=[{page:!0,$component:{src:"src/routes/[...404].tsx?pick=default&pick=$css",build:()=>import("./_...404_.mjs"),import:()=>import("./_...404_.mjs")},path:"/*404",filePath:"/home/ssmoss/Desktop/solid-auth/test-folder/lib/routes/[...404].tsx"},{page:!0,$component:{src:"src/routes/index.tsx?pick=default&pick=$css",build:()=>import("./index.mjs"),import:()=>import("./index.mjs")},$$route:{require:()=>({route:ne}),src:"lib/routes/index.tsx?pick=route"},path:"/",filePath:"/home/ssmoss/Desktop/solid-auth/test-folder/lib/routes/index.tsx"},{page:!0,$component:{src:"src/routes/login.tsx?pick=default&pick=$css",build:()=>import("./login.mjs"),import:()=>import("./login.mjs")},path:"/login",filePath:"/home/ssmoss/Desktop/solid-auth/test-folder/lib/routes/login.tsx"}],oe=ae(N.filter(e=>e.page));function ae(e){function r(t,o,n,a){const i=Object.values(t).find(c=>n.startsWith(c.id+"/"));return i?(r(i.children||(i.children=[]),o,n.slice(i.id.length)),t):(t.push({...o,id:n,path:n.replace(/\/\([^)/]+\)/g,"").replace(/\([^)/]+\)/g,"")}),t)}return e.sort((t,o)=>t.path.length-o.path.length).reduce((t,o)=>r(t,o,o.path,o.path),[])}function ie(e){return e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}te({routes:N.reduce((e,r)=>{if(!ie(r))return e;let t=r.path.replace(/\/\([^)/]+\)/g,"").replace(/\([^)/]+\)/g,"").replace(/\*([^/]*)/g,(o,n)=>`**:${n}`);if(/:[^/]*\?/g.test(t))throw new Error(`Optional parameters are not supported in API routes: ${t}`);if(e[t])throw new Error(`Duplicate API routes for "${t}" found at "${e[t].route.path}" and "${r.path}"`);return e[t]={route:r},e},{})});function ce(e){e.forEach(r=>{if(!r.attrs.href)return;let t=document.head.querySelector(`link[href="${r.attrs.href}"]`);t||(t=document.createElement("link"),t.setAttribute("rel","preload"),t.setAttribute("as","style"),t.setAttribute("href",r.attrs.href),document.head.appendChild(t))})}var ue=" ";const le={style:e=>h("style",e.attrs,()=>L(e.children),!0),link:e=>h("link",e.attrs,void 0,!0),script:e=>e.attrs.src?h("script",J(()=>e.attrs,{get id(){return e.key}}),()=>W(ue),!0):null,noscript:e=>h("noscript",e.attrs,()=>L(e.children),!0)};function pe(e,r){let{tag:t,attrs:{key:o,...n}={key:void 0},children:a}=e;return le[t]({attrs:{...n,nonce:r},key:o,children:a})}function de(e,r,t,o="default"){return _(async()=>{{const a=(await e.import())[o],c=(await r.inputs?.[e.src].assets()).filter(d=>d.tag==="style"||d.attrs.rel==="stylesheet");return typeof window<"u"&&ce(c),{default:d=>[...c.map(l=>pe(l)),z(a,d)]}}})}function fe(){function e(t){return{...t,...t.$$route?t.$$route.require().route:void 0,info:{...t.$$route?t.$$route.require().route.info:{},filesystem:!0},component:t.$component&&de(t.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:t.children?t.children.map(e):void 0}}return oe.map(e)}function he(e){const r=V(e.nativeEvent,"flash");if(!r)return;let t=JSON.parse(r);if(!t||!t.result)return;const o=[...t.input.slice(0,-1),new Map(t.input[t.input.length-1])];Q(e.nativeEvent,"flash","",{maxAge:0});const n=t.error?new Error(t.result):t.result;return{input:o,url:t.url,pending:!1,result:t.thrown?void 0:n,error:t.thrown?n:void 0}}async function me(e){const r=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await r.json(),assets:[...await r.inputs[r.handler].assets()],router:{submission:he(e)},routes:fe(),complete:!1,$islands:new Set})}const ge=new Set([301,302,303,307,308]);function ye(e){return e.status&&ge.has(e.status)?e.status:302}function we(e){const r=new TextEncoder().encode(e),t=r.length,o=t.toString(16),n="00000000".substring(0,8-o.length)+o,a=new TextEncoder().encode(`;0x${n};`),i=new Uint8Array(12+t);return i.set(a),i.set(r,12),i}function I(e,r){return new ReadableStream({start(t){X(r,{scopeId:e,plugins:[w,R,S,$,v,b,P,k,E,T],onSerialize(o,n){t.enqueue(we(n?`(${j(e)},${o})`:o))},onDone(){t.close()},onError(o){t.error(o)}})}})}async function Re(e){const r=Y(e),t=r.request,o=t.headers.get("X-Server-Id"),n=t.headers.get("X-Server-Instance"),a=t.headers.has("X-Single-Flight"),i=new URL(t.url);let c,p;if(o)se(typeof o=="string","Invalid server function"),[c,p]=o.split("#");else if(c=i.searchParams.get("id"),p=i.searchParams.get("name"),!c||!p)throw new Error("Invalid request");const d=(await globalThis.MANIFEST["server-fns"].chunks[c].import())[p];let l=[];if(!n||e.method==="GET"){const s=i.searchParams.get("args");if(s){const u=JSON.parse(s);(u.t?F(u,{plugins:[w,R,S,$,v,b,P,k,E,T]}):u).forEach(f=>l.push(f))}}if(e.method==="POST"){const s=t.headers.get("content-type"),u=e.node.req,f=u instanceof ReadableStream,q=f&&u.locked,C=f?u:u.body;if(s?.startsWith("multipart/form-data")||s?.startsWith("application/x-www-form-urlencoded"))l.push(await(q?t:new Request(t,{...t,body:C})).formData());else if(s?.startsWith("application/json")){const B=q?t:new Request(t,{...t,body:C});l=F(await B.json(),{plugins:[w,R,S,$,v,b,P,k,E,T]})}}try{let s=await D(r,async()=>(H.context={event:r},r.locals.serverFunctionMeta={id:c+"#"+p},d(...l)));if(a&&n&&(s=await M(r,s)),s instanceof Response){if(s.headers&&s.headers.has("X-Content-Raw"))return s;n&&(s.headers&&A(e,s.headers),s.status&&(s.status<300||s.status>=400)&&U(e,s.status),s.customBody?s=await s.customBody():s.body==null&&(s=null))}return n?(m(e,"content-type","text/javascript"),I(n,s)):O(s,t,l)}catch(s){if(s instanceof Response)a&&n&&(s=await M(r,s)),s.headers&&A(e,s.headers),s.status&&(!n||s.status<300||s.status>=400)&&U(e,s.status),s.customBody?s=s.customBody():s.body==null&&(s=null),m(e,"X-Error","true");else if(n){const u=s instanceof Error?s.message:typeof s=="string"?s:"true";m(e,"X-Error",u.replace(/[\r\n]+/g,""))}else s=O(s,t,l,!0);return n?(m(e,"content-type","text/javascript"),I(n,s)):s}}function O(e,r,t,o){const n=new URL(r.url),a=e instanceof Error;let i=new URL(r.headers.get("referer")).toString(),c=302;return e instanceof Response&&e.headers.has("Location")&&(i=new URL(e.headers.get("Location"),n.origin+"").toString(),c=ye(e)),new Response(null,{status:c,headers:{Location:i,...e?{"Set-Cookie":`flash=${JSON.stringify({url:n.pathname+encodeURIComponent(n.search),result:a?e.message:e,thrown:o,error:a,input:[...t.slice(0,-1),[...t[t.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}let y;async function M(e,r){let t,o=new URL(e.request.headers.get("referer")).toString();r instanceof Response&&(r.headers.has("X-Revalidate")&&(t=r.headers.get("X-Revalidate").split(",")),r.headers.has("Location")&&(o=new URL(r.headers.get("Location"),new URL(e.request.url).origin+"").toString()));const n=Z(e);return n.request=new Request(o),await D(n,async()=>{await me(n),y||(y=(await import("./app.mjs")).default),n.router.dataOnly=t||!0,n.router.previousUrl=e.request.headers.get("referer");try{G(()=>{H.context.event=n,y()})}catch(c){console.log(c)}const a=n.router.data;if(!a)return r;let i=!1;for(const c in a)a[c]===void 0?delete a[c]:i=!0;return i&&(r instanceof Response?r.customBody&&(a._$value=r.customBody()):(a._$value=r,r=new Response(null,{status:200})),r.customBody=()=>a,r.headers.set("X-Single-Flight","true")),r})}const Le=ee(Re);export{Le as default};
