import{getRequestEvent as S,isServer as l}from"solid-js/web";import{provideRequestEvent as J}from"solid-js/web/storage";import{H3Event as O,setResponseStatus as Q,sendRedirect as V,useSession as Y,setHeader as Z,getRequestIP as ee,getResponseStatus as te,getResponseStatusText as ne,getCookie as re,setCookie as se,getRequestURL as oe,getResponseHeaders as ie,getResponseHeader as ae,setResponseHeader as ue,appendResponseHeader as ce,removeResponseHeader as de,getRequestWebStream as fe}from"h3";import{getContext as le}from"unctx";import{AsyncLocalStorage as ge}from"node:async_hooks";import{createStorage as he}from"unstorage";import pe from"unstorage/drivers/fs-lite";import{createContext as W,useContext as ye,createSignal as U,getOwner as M,getListener as we,onCleanup as B,startTransition as x,sharedConfig as R,createMemo as me,$TRACK as Re}from"solid-js";function Se(e){let t;const n=N(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=Te(e),t)}})}function ve(e){return e.web??={request:Se(e),url:N(e)},e.web.request}function be(){return Ie()}const D=Symbol("$HTTPEvent");function Ee(e){return typeof e=="object"&&(e instanceof O||e?.[D]instanceof O||e?.__is_event__===!0)}function c(e){return function(...t){let n=t[0];if(Ee(n))t[0]=n instanceof O||n.__is_event__?n:n[D];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=be(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const N=c(oe),$e=c(ee),L=c(Q),k=c(te),xe=c(ne),$=c(ie),F=c(ae),Ce=c(ue),He=c(ce),lt=c(V),gt=c(re),ht=c(se),Ae=c(Y),pt=c(Z),Te=c(fe),Oe=c(de),qe=c(ve);function Ue(){return le("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ge})}function Ie(){return Ue().use().event}const T=Symbol("fetchEvent");function _e(e){return{request:qe(e),response:ke(e),clientAddress:$e(e),locals:{},nativeEvent:e}}function Pe(e){return{...e}}function yt(e){if(!e[T]){const t=_e(e);e[T]=t}return e[T]}class Le{event;constructor(t){this.event=t}get(t){const n=F(this.event,t);return Array.isArray(n)?n.join(", "):n||null}has(t){return this.get(t)!==void 0}set(t,n){return Ce(this.event,t,n)}delete(t){return Oe(this.event,t)}append(t,n){He(this.event,t,n)}getSetCookie(){const t=F(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries($(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries($(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys($(this.event))[Symbol.iterator]()}values(){return Object.values($(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function ke(e){return{get status(){return k(e)},set status(t){L(e,t)},get statusText(){return xe(e)},set statusText(t){L(e,k(e),t)},headers:new Le(e)}}function H(e,t,n){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const r="";return new Proxy(e,{get(s,o,d){return o==="url"?`${r}/_server?id=${encodeURIComponent(t)}&name=${encodeURIComponent(n)}`:o==="GET"?d:s[o]},apply(s,o,d){const u=S();if(!u)throw new Error("Cannot call server function outside of a request");const f=Pe(u);return f.locals.serverFunctionMeta={id:t+"#"+n},f.serverOnly=!0,J(f,()=>e.apply(o,d))}})}const Fe="http://sr";function je(e,t){if(e==null)throw new Error(t);return e}const We=W();W();const K=()=>je(ye(We),"<A> and 'use' router primitives can be only used inside a Route."),Me=()=>K().navigatorFactory();let Be;function De(){return Be}const Ne="Location",Ke=5e3,Xe=18e4;let b=new Map;l||setInterval(()=>{const e=Date.now();for(let[t,n]of b.entries())!n[3].count&&e-n[0]>Xe&&b.delete(t)},3e5);function I(){if(!l)return b;const e=S();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function Ge(e,t=!0){return x(()=>{const n=Date.now();X(e,r=>{t&&(r[0]=0),r[3][1](n)})})}function X(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of b.keys())(e===void 0||ze(n,e))&&t(b.get(n))}function A(e,t){e.GET&&(e=e.GET);const n=(...r)=>{const s=I(),o=De(),u=M()?Me():void 0,f=Date.now(),g=t+q(r);let i=s.get(g),m;if(l){const a=S();if(a){const y=(a.router||(a.router={})).dataOnly;if(y){const w=a&&(a.router.data||(a.router.data={}));if(w&&g in w)return w[g];if(Array.isArray(y)&&!y.includes(g))return w[g]=void 0,Promise.resolve()}}}if(we()&&!l&&(m=!0,B(()=>i[3].count--)),i&&i[0]&&(l||o==="native"||i[3].count||Date.now()-i[0]<Ke)){m&&(i[3].count++,i[3][0]()),i[2]==="preload"&&o!=="preload"&&(i[0]=f);let a=i[1];return a="then"in i[1]?i[1].then(p(!1),p(!0)):p(!1)(i[1]),!l&&o==="navigate"&&x(()=>i[3][1](i[0])),a}let h=!l&&R.context&&R.has(g)?R.load(g):e(...r);if(i?(i[0]=f,i[1]=h,i[2]=o,!l&&o==="navigate"&&x(()=>i[3][1](i[0]))):(s.set(g,i=[f,h,o,U(f)]),i[3].count=0),m&&(i[3].count++,i[3][0]()),l){const a=S();if(a&&a.router.dataOnly)return a.router.data[g]=h}if(h="then"in h?h.then(p(!1),p(!0)):p(!1)(h),l&&R.context&&R.context.async&&!R.context.noHydrate){const a=S();(!a||!a.serverOnly)&&R.context.serialize(g,h)}return h;function p(a){return async y=>{if(y instanceof Response){const w=y.headers.get(Ne);if(w!==null){if(u&&w.startsWith("/"))x(()=>{u(w,{replace:!0})});else if(!l)window.location.href=w;else if(l){const P=S();P&&(P.response={status:302,headers:new Headers({Location:w})})}return}y.customBody&&(y=await y.customBody())}if(a)throw y;return y}}};return n.keyFor=(...r)=>t+q(r),n.key=t,n}A.set=(e,t)=>{const n=I(),r=Date.now();let s=n.get(e);s?(s[0]=r,s[1]=t,s[2]="preload"):(n.set(e,s=[r,t,,U(r)]),s[3].count=0)};A.clear=()=>I().clear();function ze(e,t){for(let n of t)if(e.startsWith(n))return!0;return!1}function q(e){return JSON.stringify(e,(t,n)=>Je(n)?Object.keys(n).sort().reduce((r,s)=>(r[s]=n[s],r),{}):n)}function Je(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const j=new Map;function Qe(e,t){const n=K(),r=me(()=>n.submissions[0]().filter(s=>s.url===e.toString()&&!t));return new Proxy([],{get(s,o){return o===Re?r():o==="pending"?r().some(d=>!d.result):r()[o]}})}function wt(e,t){const n=Qe(e,t);return new Proxy({},{get(r,s){return n.length===0&&s==="clear"||s==="retry"?()=>{}:n[n.length-1]?.[s]}})}function G(e,t){function n(...s){const o=this.r,d=this.f,u=(o.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...s),[f,g]=U();let i;function m(h){return async p=>{const a=await Ye(p,h,o.navigatorFactory());if(!a)return i.clear();if(g(a),a.error&&!d)throw a.error;return a.data}}return o.submissions[1](h=>[...h,i={input:s,url:r,get result(){return f()?.data},get error(){return f()?.error},get pending(){return!f()},clear(){o.submissions[1](p=>p.filter(a=>a.input!==s))},retry(){return g(void 0),e(...s).then(m(),m(!0))}}]),u.then(m(),m(!0))}const r=e.url||t||(l?"":`https://action/${Ve(e.toString())}`);return z(n,r)}function z(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const r=function(...o){return e.call(this,...n,...o)},s=new URL(t,Fe);return s.searchParams.set("args",q(n)),z(r,(s.origin==="https://action"?s.origin:"")+s.pathname+s.search)},e.url=t,l||(j.set(t,e),M()&&B(()=>j.delete(t))),e}const Ve=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function Ye(e,t,n){let r,s,o,d;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(o=e.headers.get("X-Revalidate").split(",")),e.customBody&&(r=s=await e.customBody(),e.headers.has("X-Single-Flight")&&(r=r._$value,delete s._$value,d=Object.keys(s))),e.headers.has("Location")){const u=e.headers.get("Location")||"/";u.startsWith("http")?window.location.href=u:n(u)}}else{if(t)return{error:e};r=e}return X(o,u=>u[0]=0),d&&d.forEach(u=>A.set(u,s[u])),await Ge(o,!1),r!=null?{data:r}:void 0}function _(e,t=302){let n,r;typeof t=="number"?n={status:t}:({revalidate:r,...n}=t,typeof n.status>"u"&&(n.status=302));const s=new Headers(n.headers);return s.set("Location",e),r&&s.set("X-Revalidate",r.toString()),new Response(null,{...n,headers:s})}const v=he({driver:pe({base:"./.data"})});v.setItem("users:data",[{id:0,username:"kody",password:"twixrox"}]);v.setItem("users:counter",1);const C={user:{async create({data:e}){const[{value:t},{value:n}]=await v.getItems(["users:data","users:counter"]),r={...e,id:n};return await Promise.all([v.setItem("users:data",[...t,r]),v.setItem("users:counter",n+1)]),r},async findUnique({where:{username:e=void 0,id:t=void 0}}){const n=await v.getItem("users:data");return t!==void 0?n.find(r=>r.id===t):n.find(r=>r.username===e)}}},E={getSession:async()=>{const e=await Ae({password:process.env.SESSION_SECRET??"areallylongsecretthatyoushouldreplace"});return{...e,update:async t=>{const n={...e.data};t(n),await e.update(r=>({...r,...n}))}}},login:async(e,t)=>{const n=await C.user.findUnique({where:{username:e}});if(!n||t!==n.password)throw new Error("Invalid login");return{...n,id:n.id}},register:async(e,t)=>{if(await C.user.findUnique({where:{username:e}}))throw new Error("User already exists");return C.user.create({data:{username:e,password:t}})},logout:async()=>{const e=await E.getSession();e?.data.userId&&await e.update(t=>{t.userId=void 0})},validateUsername:e=>{if(typeof e!="string"||e.length<3)return"Usernames must be at least 3 characters long"},validatePassword:e=>{if(typeof e!="string"||e.length<6)return"Passwords must be at least 6 characters long"}},mt=A(H(et,"c_5810","$$function0"),"user"),Rt=G(H(tt,"c_5810","$$function1")),Ze=H(nt,"c_5810","$$function2"),St=G(H(rt,"c_5810","$$function3"));async function et(){try{const e=await E.getSession(),t=Number(e.data.userId);if(t===void 0)throw new Error("User not found");const n=await C.user.findUnique({where:{id:t}});if(!n)throw new Error("User not found");return{id:n.id,username:n.username}}catch{await E.logout(),_("/login")}}async function tt(e){return Ze(e,E)}async function nt(e,t){const n=String(e.get("username")),r=String(e.get("password")),s=String(e.get("loginType"));let o=t.validateUsername(n)||t.validatePassword(r);if(o)return new Error(o);try{const d=await(s!=="login"?t.register(n,r):t.login(n,r));await(await t.getSession()).update(f=>{f.userId=d.id.toString()})}catch(d){return d}return _("/")}async function rt(){return await E.logout(),_("/login")}export{gt as a,yt as b,lt as c,L as d,pt as e,Rt as f,mt as g,St as l,ht as s,wt as u};
